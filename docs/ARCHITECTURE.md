# ç³»ç»Ÿæ¶æ„

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   OpenClaw Gateway                        â”‚
â”‚                   (ç›‘æ§ç›®æ ‡)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ å¿ƒè·³æ›´æ–° (æ¯ 1 åˆ†é’Ÿ)
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Heartbeat Timer (systemd)                    â”‚
â”‚              update-heartbeat.sh                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ å¿ƒè·³æ£€æŸ¥
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Watchdog Timer (systemd)                       â”‚
â”‚            gateway-watchdog.sh (æ¯ 2 åˆ†é’Ÿ)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”œâ”€â–º è¿›ç¨‹æ£€æµ‹ (PID æ£€æŸ¥)
                â”œâ”€â–º å¿ƒè·³æ£€æµ‹ (5 åˆ†é’Ÿè¶…æ—¶)
                â”œâ”€â–º åŠŸèƒ½æ£€æµ‹ (CPU ä½¿ç”¨ç‡)
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ­£å¸¸ï¼Ÿ       â”‚
        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
            â”‚       â”‚
        æ˜¯  â”‚       â”‚ å¦
            â”‚       â–¼
            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   â”‚        å››çº§æ¢å¤ç³»ç»Ÿ                  â”‚
            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚               â”‚
            â”‚               â”œâ”€â–º Level 1: åŸºç¡€é‡å¯
            â”‚               â”œâ”€â–º Level 2: å¼ºåˆ¶é‡å¯
            â”‚               â”œâ”€â–º Level 3: AI ä¿®å¤
            â”‚               â””â”€â–º Level 4: ç´§æ€¥å‘Šè­¦
            â”‚                   â”‚
            â”‚                   â–¼
            â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚           â”‚  é‚®ä»¶é€šçŸ¥      â”‚
            â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Backup System (æ¯ 3 å°æ—¶)                       â”‚
â”‚          backup-gateway-db.sh                            â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        SQLite Database                          â”‚   â”‚
â”‚  â”‚  - Gateway é…ç½® (base64)                         â”‚   â”‚
â”‚  â”‚  - æ‰€æœ‰ Skills (ç”¨æˆ· + ç³»ç»Ÿ)                     â”‚   â”‚
â”‚  â”‚  - ç³»ç»Ÿä¿¡æ¯                                      â”‚   â”‚
â”‚  â”‚  - å¤‡ä»½å…ƒæ•°æ®                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  ä¿ç•™ 30 ä»½ï¼Œè‡ªåŠ¨æ¸…ç†                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” å¤šå±‚æ£€æµ‹ç³»ç»Ÿ

### 1. è¿›ç¨‹æ£€æµ‹
æ£€æŸ¥ Gateway è¿›ç¨‹æ˜¯å¦å­˜åœ¨

```bash
pgrep -f "openclaw gateway" > /dev/null
```

### 2. å¿ƒè·³æ£€æµ‹
æ£€æŸ¥å¿ƒè·³æ—¶é—´æˆ³æ˜¯å¦è¶…æ—¶ï¼ˆ5 åˆ†é’Ÿï¼‰

```bash
HEARTBEAT_FILE="$HOME/.openclaw/watchdog/heartbeat.timestamp"
LAST_HEARTBEAT=$(cat "$HEARTBEAT_FILE")
CURRENT_TIME=$(date +%s)
ELAPSED=$((CURRENT_TIME - LAST_HEARTBEAT))

if [ $ELAPSED -gt $HEARTBEAT_TIMEOUT ]; then
    # å¿ƒè·³è¶…æ—¶
fi
```

### 3. åŠŸèƒ½æ£€æµ‹
æ£€æŸ¥ CPU ä½¿ç”¨ç‡ï¼Œé˜²æ­¢è¿›ç¨‹åƒµæ­»

```bash
CPU_USAGE=$(ps -p $PID -o %cpu --no-headers | awk '{print int($1)}')

if [ $CPU_USAGE -gt 95 ]; then
    # CPU è¿‡é«˜ï¼Œå¯èƒ½åƒµæ­»
fi
```

## ğŸ›¡ï¸ å››çº§æ¢å¤ç³»ç»Ÿ

### Level 1: åŸºç¡€é‡å¯
ä½¿ç”¨ OpenClaw å‘½ä»¤é‡å¯

```bash
openclaw gateway restart
```

**é€‚ç”¨åœºæ™¯**: è¿›ç¨‹å¡æ­»ã€é…ç½®é—®é¢˜

### Level 2: å¼ºåˆ¶é‡å¯
å¼ºåˆ¶æ€æ­»è¿›ç¨‹ï¼Œæ¸…ç†æ®‹ç•™ï¼Œé‡å¯

```bash
# å¼ºåˆ¶æ€æ­»
pkill -9 -f "openclaw gateway"

# æ¸…ç†æ®‹ç•™
sleep 2
pkill -9 -f "openclaw gateway"

# å¯åŠ¨
openclaw gateway start
```

**é€‚ç”¨åœºæ™¯**: è¿›ç¨‹æ— å“åº”ã€ç«¯å£å ç”¨

### Level 3: AI æ·±åº¦ä¿®å¤
ä½¿ç”¨ Opencode AI åˆ†æå¹¶ä¿®å¤

```bash
opencode "
æˆ‘éœ€è¦ä½ å¸®åŠ©ä¿®å¤ OpenClaw Gatewayã€‚
å½“å‰çŠ¶æ€: Gateway æ— æ³•å¯åŠ¨
è¯·åˆ†ææ—¥å¿—ã€é…ç½®ã€ä¾èµ–ï¼Œå¹¶æä¾›ä¿®å¤æ–¹æ¡ˆã€‚
"
```

**é€‚ç”¨åœºæ™¯**: æœªçŸ¥é”™è¯¯ã€é…ç½®æŸåã€ä¾èµ–é—®é¢˜

**ç‰¹æ€§**:
- ä¸´æ—¶å¯åŠ¨ Opencodeï¼ˆä¸å¸¸é©»ï¼‰
- è‡ªåŠ¨åˆ†ææ—¥å¿—å’Œé…ç½®
- æä¾›ä¿®å¤å»ºè®®
- ä¿®å¤å®Œæˆåè‡ªåŠ¨å…³é—­

### Level 4: ç´§æ€¥å‘Šè­¦
æ‰€æœ‰æ¢å¤å¤±è´¥ï¼Œå‘é€ç´§æ€¥é‚®ä»¶

**å†…å®¹**:
- æ•…éšœæ—¶é—´
- æ•…éšœè¯¦æƒ…
- å°è¯•çš„æ¢å¤æ–¹æ³•
- æ—¥å¿—æ‘˜è¦

**é€‚ç”¨åœºæ™¯**: ä¸¥é‡æ•…éšœï¼Œéœ€è¦äººå·¥ä»‹å…¥

## ğŸ’¾ æ•°æ®åº“å¤‡ä»½ç³»ç»Ÿ

### å¤‡ä»½å†…å®¹

1. **Gateway é…ç½®**
   - æœåŠ¡é…ç½®æ–‡ä»¶
   - ç¯å¢ƒå˜é‡
   - Systemd é…ç½®

2. **æ‰€æœ‰ Skills**
   - ç”¨æˆ·å·¥ä½œåŒº Skills (`~/.openclaw/workspace/skills/`)
   - ç³»ç»Ÿå®‰è£… Skills (`~/.nvm/versions/node/v22.22.0/lib/node_modules/openclaw/skills/`)

3. **ç³»ç»Ÿä¿¡æ¯**
   - OpenClaw ç‰ˆæœ¬
   - ç³»ç»Ÿç‰ˆæœ¬
   - Node ç‰ˆæœ¬

### æ•°æ®åº“ç»“æ„

```sql
CREATE TABLE backups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp INTEGER NOT NULL,
    datetime TEXT NOT NULL,
    type TEXT NOT NULL,
    content TEXT NOT NULL,
    size INTEGER
);

CREATE TABLE backup_info (
    key TEXT PRIMARY KEY,
    value TEXT
);
```

### å¤‡ä»½ç­–ç•¥

- **é¢‘ç‡**: æ¯ 3 å°æ—¶ï¼ˆ0, 3, 6, 9, 12, 15, 18, 21ï¼‰
- **ä¿ç•™**: æœ€è¿‘ 30 ä»½
- **æ¸…ç†**: è‡ªåŠ¨åˆ é™¤è¶…è¿‡ 30 ä»½çš„æ—§å¤‡ä»½
- **ç¼–ç **: Base64ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰

## ğŸ“§ é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ

### é€šçŸ¥æ—¶åˆ»

1. **å¼‚å¸¸é€šçŸ¥**
   - Gateway å¼‚å¸¸ç»ˆæ­¢ - å¼€å§‹ä¿®å¤ (Level X)
   - Gateway å¼‚å¸¸ç»ˆæ­¢ - å‡çº§ä¿®å¤ (Level 2/3)
   - Gateway å¼‚å¸¸ç»ˆæ­¢ - æ·±åº¦ä¿®å¤ (Level 3)
   - ç´§æ€¥å‘Šè­¦ - Gateway æ— æ³•æ¢å¤

2. **æˆåŠŸé€šçŸ¥**
   - Gateway å·²æ¢å¤æˆåŠŸ (Level X)

3. **å¤‡ä»½é€šçŸ¥**
   - Gateway é…ç½®å¤‡ä»½å®Œæˆ

### é‚®ä»¶æ ¼å¼

**ä¸»é¢˜**: ç®€æ´æ ¼å¼
```
Gatewayå¼‚å¸¸ç»ˆæ­¢ - å¼€å§‹ä¿®å¤(Level 1)
Gatewayå·²æ¢å¤æˆåŠŸ(Level 2)
Gatewayé…ç½®å¤‡ä»½å®Œæˆ
```

**å†…å®¹**: åŒ…å«æ—¶é—´ã€è¯¦æƒ…ã€æ“ä½œ

## âš™ï¸ Systemd è¿›ç¨‹ç®¡ç†

### å®šæ—¶å™¨é…ç½®

**çœ‹é—¨ç‹—å®šæ—¶å™¨**
- é¢‘ç‡: æ¯ 2 åˆ†é’Ÿ
- æœåŠ¡: `openclaw-gateway-watchdog.service`
- è„šæœ¬: `gateway-watchdog.sh`

**å¿ƒè·³å®šæ—¶å™¨**
- é¢‘ç‡: æ¯ 1 åˆ†é’Ÿ
- æœåŠ¡: `openclaw-gateway-heartbeat.service`
- è„šæœ¬: `update-heartbeat.sh`

### æœåŠ¡æ–‡ä»¶

```ini
[Unit]
Description=OpenClaw Gateway Watchdog
After=network.target

[Service]
Type=oneshot
ExecStart=/root/.openclaw/scripts/gateway-watchdog.sh
User=root

[Install]
WantedBy=multi-user.target
```

## ğŸ”’ å†™ä¿æŠ¤ç³»ç»Ÿ

### ä¿æŠ¤æ–¹å¼

ä½¿ç”¨ `chattr +i` è®¾ç½®æ–‡ä»¶ä¸ºä¸å¯å˜ï¼š

```bash
chattr +i ~/.openclaw/scripts/gateway-watchdog.sh
chattr +i /etc/systemd/system/openclaw-gateway-watchdog.service
```

### ç®¡ç†å·¥å…·

```bash
# æ£€æŸ¥çŠ¶æ€
bash ~/.openclaw/scripts/watchdog-protection.sh check

# ç§»é™¤ä¿æŠ¤
bash ~/.openclaw/scripts/watchdog-protection.sh remove

# æ·»åŠ ä¿æŠ¤
bash ~/.openclaw/scripts/watchdog-protection.sh add
```

### ç‰¹æ®Šæƒ…å†µ

- **Opencode ä¿®å¤**: è‡ªåŠ¨ç§»é™¤ä¿æŠ¤ï¼Œä¿®å¤åé‡æ–°å¯ç”¨
- **è„šæœ¬æ›´æ–°**: éœ€è¦å…ˆç§»é™¤ä¿æŠ¤ï¼Œæ›´æ–°åé‡æ–°å¯ç”¨

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—æ–‡ä»¶

- **çœ‹é—¨ç‹—æ—¥å¿—**: `~/.openclaw/watchdog/watchdog.log`
- **Gateway æ—¥å¿—**: `~/.openclaw/logs/gateway.log`
- **ç³»ç»Ÿæ—¥å¿—**: `journalctl -u openclaw-gateway-watchdog`

### çŠ¶æ€æŸ¥è¯¢

```bash
# çœ‹é—¨ç‹—çŠ¶æ€
bash ~/.openclaw/scripts/watchdog-manager.sh status

# å¤‡ä»½åˆ—è¡¨
bash ~/.openclaw/scripts/backup-db-query.sh

# å¿ƒè·³æ—¶é—´
cat ~/.openclaw/watchdog/heartbeat.timestamp
```

## ğŸ¯ å·¥ä½œæµç¨‹

### æ­£å¸¸æµç¨‹

```
1. Gateway è¿è¡Œä¸­
2. å¿ƒè·³å®šæ—¶å™¨æ¯ 1 åˆ†é’Ÿæ›´æ–°å¿ƒè·³
3. çœ‹é—¨ç‹—å®šæ—¶å™¨æ¯ 2 åˆ†é’Ÿæ£€æŸ¥
4. å‘ç° Gateway æ­£å¸¸ï¼Œè·³è¿‡æ¢å¤
5. æ¯ 3 å°æ—¶æ‰§è¡Œå¤‡ä»½
6. å‘é€å¤‡ä»½å®Œæˆé‚®ä»¶
```

### å¼‚å¸¸æµç¨‹

```
1. Gateway å´©æºƒ
2. å¿ƒè·³åœæ­¢æ›´æ–°
3. çœ‹é—¨ç‹—æ£€æµ‹åˆ°è¶…æ—¶
4. å‘é€å¼‚å¸¸é€šçŸ¥é‚®ä»¶
5. æ‰§è¡Œ Level 1 æ¢å¤
6. ç­‰å¾… 30 ç§’
7. æ£€æŸ¥æ˜¯å¦æ¢å¤
8. å¦‚æœæœªæ¢å¤ï¼Œå‡çº§åˆ° Level 2
9. é‡å¤å‡çº§è¿‡ç¨‹
10. å¦‚æœæ‰€æœ‰çº§åˆ«å¤±è´¥ï¼Œå‘é€ç´§æ€¥å‘Šè­¦
```

---

ğŸ• **è®© Gateway å®ˆæŠ¤ä½ çš„ OpenClawï¼**
